{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",

  "data": { "url": "../data/cars_info.csv" },

  "params": [
    {
      "name": "brand_selection",
      "select": { "type": "point", "fields": ["Brand"], "on": "click" }
    }
  ],

  "vconcat": [
    {
      "title": { "text": "Most Popular Car Brands in Australia", "fontSize": 16, "fontWeight": "bold" },
      "width": "container",
      "height": 400,
      "transform": [
        { "aggregate": [{ "op": "count", "as": "Count" }], "groupby": ["Brand"] },
        { "window": [{ "op": "rank", "as": "rank" }], "sort": [{ "field": "Count", "order": "descending" }] },
        { "filter": "datum.rank <= 15" }
      ],
      "layer": [
        {
          "mark": { "type": "bar", "tooltip": true, "cursor": "pointer" },
          "encoding": {
            "y": { "field": "Brand", "type": "nominal", "sort": "-x", "axis": { "title": null, "labelFontSize": 11 } },
            "x": {
              "field": "Count", "type": "quantitative", "title": "Number of Listings",
              "axis": { "labelExpr": "datum.value >= 1000 ? format(datum.value, '~s') : format(datum.value, ',')", "labelFontSize": 10 },
              "scale": { "nice": true }
            },
            "color": {
              "condition": { "param": "brand_selection", "value": "#e7ba52", "empty": false },
              "value": "#4c78a8"
            },
            "opacity": { "condition": { "param": "brand_selection", "value": 1, "empty": true }, "value": 0.7 },
            "tooltip": [
              { "field": "Brand", "type": "nominal" },
              { "field": "Count", "type": "quantitative", "title": "Listings", "format": "," }
            ]
          }
        },
        {
          
          "data": { "values": [ { "Status": "Selected Brand" }, { "Status": "Other Brands" } ] },
          "mark": { "type": "point", "opacity": 0 },
          "encoding": {
            "color": {
              "field": "Status", "type": "nominal",
              "scale": { "domain": ["Selected Brand", "Other Brands"], "range": ["#e7ba52", "#4c78a8"] },
              "legend": { "title": "Legend", "orient": "bottom", "columns": 2, "labelFontSize": 11, "titleFontSize": 11 }
            }
          }
        }
      ]
    },

    {
      "title": { "text": "Average Price by Year (Click a brand above)", "fontSize": 16, "fontWeight": "bold" },
      "width": "container",
      "height": 400,
      "transform": [
        { "filter": "datum.Price != null && datum.Year != null" },
        { "calculate": "toNumber(replace(replace(datum.Price,'$',''),',',''))", "as": "PriceNum" },
        { "calculate": "toNumber(datum.Year)", "as": "YearNum" },
        { "filter": "datum.YearNum >= 2010 && datum.YearNum <= 2025" },

        
        { "aggregate": [ { "op": "mean", "field": "PriceNum", "as": "AvgPrice" }, { "op": "count", "as": "Count" } ], "groupby": ["Brand", "YearNum"] },
        { "joinaggregate": [ { "op": "sum", "field": "Count", "as": "BrandTotal" } ], "groupby": ["Brand"] },
        { "window": [ { "op": "dense_rank", "as": "BrandRank" } ], "sort": [ { "field": "BrandTotal", "order": "descending" } ] },
        { "filter": "datum.BrandRank <= 15" },

      
        { "filter": { "param": "brand_selection" } }
      ],
      "mark": { "type": "line", "point": true, "strokeWidth": 3, "tooltip": true },
      "encoding": {
        "x": { "field": "YearNum", "type": "ordinal", "axis": { "title": "Year", "labelAngle": -45, "labelFontSize": 10 } },
        "y": { "field": "AvgPrice", "type": "quantitative", "title": "Average Price (AUD)", "axis": { "format": "$,.0f", "labelFontSize": 10 }, "scale": { "zero": false } },
        "color": { "field": "Brand", "type": "nominal", "legend": null },
        "tooltip": [
          { "field": "Brand", "type": "nominal" },
          { "field": "YearNum", "type": "ordinal", "title": "Year" },
          { "field": "AvgPrice", "type": "quantitative", "title": "Avg Price", "format": "$,.0f" }
        ]
      }
    }
  ]
}
